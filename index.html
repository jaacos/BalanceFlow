<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Presupuesto Personal</title>

    <!-- PWA Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="jaacos/icono_enmascarable_192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .balance-positive { color: #10B981; }
        .balance-negative { color: #EF4444; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-hidden { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6">
        
        <header class="text-center space-y-4">
            <img src="jaacos/icono_enmascarable_192.png" alt="Logo de la App" class="mx-auto h-16 w-auto">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Calculadora de Presupuesto Mensual</h1>
            <p class="text-slate-500">Registra, analiza y mejora tus finanzas.</p>
        </header>

        <section class="flex justify-center items-center gap-4 bg-slate-50 p-3 rounded-lg">
            <label for="month-select" class="font-medium text-slate-600">Periodo:</label>
            <select id="month-select" class="bg-white border border-slate-300 rounded-md py-1 px-2 text-sm shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></select>
            <input type="number" id="year-input" class="w-24 bg-white border border-slate-300 rounded-md py-1 px-2 text-sm shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
        </section>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
            <div class="bg-green-50 p-4 rounded-lg"><h2 class="text-sm font-medium text-green-700">INGRESOS TOTALES</h2><p id="total-income" class="text-2xl font-semibold text-green-600">0.00 €</p></div>
            <div class="bg-red-50 p-4 rounded-lg"><h2 class="text-sm font-medium text-red-700">GASTOS TOTALES</h2><p id="total-expense" class="text-2xl font-semibold text-red-600">0.00 €</p></div>
            <div class="bg-slate-50 p-4 rounded-lg"><h2 class="text-sm font-medium text-slate-700">BALANCE NETO</h2><p id="balance" class="text-2xl font-semibold text-slate-800">0.00 €</p></div>
        </section>

        <section>
            <h3 class="text-lg font-semibold mb-3 text-slate-700">Añadir nueva transacción</h3>
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-2"><label for="description" class="text-sm font-medium text-slate-600">Descripción</label><input type="text" id="description" placeholder="Ej: Nómina, Alquiler..." class="mt-1 w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required></div>
                <div><label for="amount" class="text-sm font-medium text-slate-600">Importe (€)</label><input type="number" id="amount" placeholder="0.00" step="0.01" class="mt-1 w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required></div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Añadir</button>
            </form>
        </section>
        
        <section class="border-t pt-4 text-center">
             <button id="show-analysis-btn" class="w-full md:w-auto bg-emerald-500 text-white font-semibold py-2 px-6 rounded-md hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition">
                Analizar y Exportar Mes
            </button>
        </section>

        <section>
            <h3 class="text-lg font-semibold mb-3 text-slate-700">Historial de Transacciones</h3>
            <div class="bg-slate-50 rounded-lg p-4 h-64 overflow-y-auto custom-scrollbar">
                <ul id="transaction-list" class="space-y-3">
                     <p id="empty-list-message" class="text-center text-slate-500 pt-8">Aún no hay transacciones.</p>
                </ul>
            </div>
        </section>

    </div>

    <!-- Analysis Modal -->
    <div id="analysis-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-3xl max-h-[90vh] overflow-y-auto custom-scrollbar space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-900">Análisis de <span id="analysis-month-year"></span></h2>
                <button id="close-analysis-btn" class="p-2 rounded-full text-slate-500 hover:text-slate-900 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">Feedback Financiero Rápido</h3>
                <div id="feedback-content" class="bg-slate-50 p-4 rounded-lg text-slate-700 text-sm space-y-2"></div>
            </div>

            <div>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">Exportar Datos para Análisis Externo</h3>
                <p class="text-sm text-slate-500 mb-3">Copia este texto y pégalo en tu IA de preferencia para un análisis detallado.</p>
                <textarea id="export-data-textarea" readonly class="w-full h-40 p-3 bg-slate-100 border border-slate-200 rounded-md text-xs font-mono custom-scrollbar"></textarea>
                <button id="copy-data-btn" class="mt-2 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                    Copiar al Portapapeles
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const balanceEl = document.getElementById('balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const transactionListEl = document.getElementById('transaction-list');
        const form = document.getElementById('transaction-form');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const emptyListMessage = document.getElementById('empty-list-message');
        const monthSelect = document.getElementById('month-select');
        const yearInput = document.getElementById('year-input');
        
        // Modal Elements
        const showAnalysisBtn = document.getElementById('show-analysis-btn');
        const analysisModal = document.getElementById('analysis-modal');
        const closeAnalysisBtn = document.getElementById('close-analysis-btn');
        const analysisMonthYearEl = document.getElementById('analysis-month-year');
        const feedbackContentEl = document.getElementById('feedback-content');
        const exportDataTextarea = document.getElementById('export-data-textarea');
        const copyDataBtn = document.getElementById('copy-data-btn');

        const LOCAL_STORAGE_KEY = 'budget_app_data_es_pwa_v1';
        let allTransactions = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || {};

        function setupDateSelectors() {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const now = new Date();
            monthSelect.innerHTML = months.map((month, index) => `<option value="${index}" ${index === now.getMonth() ? 'selected' : ''}>${month}</option>`).join('');
            yearInput.value = now.getFullYear();
        }

        function getCurrentPeriodKey() { return `${yearInput.value}-${monthSelect.value}`; }
        function generateID() { return Date.now() + Math.random(); }

        function addTransactionDOM(transaction) {
            const item = document.createElement('li');
            const sign = transaction.amount < 0 ? '-' : '+';
            const typeClass = transaction.amount < 0 ? 'border-red-400' : 'border-green-400';
            item.classList.add('flex', 'justify-between', 'items-center', 'bg-white', 'p-3', 'rounded-md', 'shadow-sm', 'border-l-4', typeClass);
            item.innerHTML = `
                <span class="flex-1">${transaction.description}</span>
                <span class="font-semibold ${transaction.amount < 0 ? 'text-red-600' : 'text-green-600'}">${sign}${Math.abs(transaction.amount).toFixed(2)} €</span>
                <button class="ml-4 text-slate-400 hover:text-red-600 transition-colors" onclick="removeTransaction(${transaction.id})">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>`;
            transactionListEl.appendChild(item);
        }

        function updateSummary(transactions) {
            const amounts = transactions.map(t => t.amount);
            const total = amounts.reduce((acc, item) => acc + item, 0);
            const income = amounts.filter(item => item > 0).reduce((acc, item) => acc + item, 0);
            const expense = amounts.filter(item => item < 0).reduce((acc, item) => acc + item, 0);

            totalIncomeEl.innerText = `${income.toFixed(2)} €`;
            totalExpenseEl.innerText = `${Math.abs(expense).toFixed(2)} €`;
            balanceEl.innerText = `${total.toFixed(2)} €`;
            balanceEl.className = 'text-2xl font-semibold';
            balanceEl.classList.add(total >= 0 ? 'balance-positive' : 'balance-negative');
        }

        function refreshView() {
            const periodKey = getCurrentPeriodKey();
            const currentTransactions = allTransactions[periodKey] || [];
            transactionListEl.innerHTML = '';
            if (currentTransactions.length === 0) {
                emptyListMessage.style.display = 'block';
            } else {
                emptyListMessage.style.display = 'none';
                currentTransactions.forEach(addTransactionDOM);
            }
            updateSummary(currentTransactions);
        }

        function handleAddTransaction(e) {
            e.preventDefault();
            if (descriptionInput.value.trim() === '' || amountInput.value.trim() === '') return;
            const periodKey = getCurrentPeriodKey();
            const transaction = { id: generateID(), description: descriptionInput.value, amount: +amountInput.value };
            if (!allTransactions[periodKey]) allTransactions[periodKey] = [];
            allTransactions[periodKey].push(transaction);
            updateLocalStorage();
            refreshView();
            form.reset();
            descriptionInput.focus();
        }

        function removeTransaction(id) {
            const periodKey = getCurrentPeriodKey();
            if (allTransactions[periodKey]) {
                allTransactions[periodKey] = allTransactions[periodKey].filter(t => t.id !== id);
                updateLocalStorage();
                refreshView();
            }
        }

        function updateLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allTransactions));
        }

        function generateFeedback() {
            const periodKey = getCurrentPeriodKey();
            const transactions = allTransactions[periodKey] || [];
            if (transactions.length === 0) {
                feedbackContentEl.innerHTML = `<p>No hay datos para analizar en este periodo.</p>`;
                return;
            }

            const income = transactions.filter(t => t.amount > 0).reduce((acc, t) => acc + t.amount, 0);
            const expensesList = transactions.filter(t => t.amount < 0);
            const totalExpenses = expensesList.reduce((acc, t) => acc + Math.abs(t.amount), 0);
            
            let feedbackHTML = '';

            if (income === 0 && totalExpenses > 0) {
                 feedbackHTML += `<p><strong>Atención:</strong> Has registrado gastos pero no ingresos. Asegúrate de añadir tus fuentes de ingreso para un análisis completo.</p>`;
            } else if (income > 0) {
                const savingsRate = ((income - totalExpenses) / income) * 100;
                feedbackHTML += `<p><strong>Tasa de Ahorro:</strong> ${savingsRate.toFixed(1)}%</p>`;
                if (savingsRate > 20) {
                    feedbackHTML += `<p><strong>Análisis:</strong> ¡Excelente! Estás ahorrando una parte muy saludable de tus ingresos. Sigue así.</p>`;
                } else if (savingsRate >= 10) {
                    feedbackHTML += `<p><strong>Análisis:</strong> Vas por buen camino. Tu tasa de ahorro es positiva. Revisa tus gastos para ver si puedes optimizarla aún más.</p>`;
                } else if (savingsRate >= 0) {
                     feedbackHTML += `<p><strong>Análisis:</strong> Tu margen de ahorro es ajustado. Es un buen momento para revisar tus gastos variables y buscar áreas de recorte.</p>`;
                } else {
                    feedbackHTML += `<p><strong>Análisis:</strong> <span class="font-bold text-red-600">¡Alerta!</span> Tus gastos superan tus ingresos. Es crucial revisar tu presupuesto de inmediato.</p>`;
                }
            } else {
                 feedbackHTML += `<p>Añade ingresos y gastos para poder generar un análisis.</p>`;
            }

            if (expensesList.length > 0) {
                const topExpenses = expensesList
                    .sort((a, b) => a.amount - b.amount)
                    .slice(0, 3)
                    .map(t => `${t.description} (${Math.abs(t.amount).toFixed(2)} €)`);
                feedbackHTML += `<p class="mt-4"><strong>Principales Gastos:</strong> ${topExpenses.join(', ')}.</p>`;
            }
            
            feedbackContentEl.innerHTML = feedbackHTML;
        }

        function generateExportText() {
            const periodKey = getCurrentPeriodKey();
            const transactions = allTransactions[periodKey] || [];
            const selectedMonthName = monthSelect.options[monthSelect.selectedIndex].text;
            const year = yearInput.value;

            let report = `Analiza los siguientes datos de mis finanzas personales para ${selectedMonthName} de ${year} y dame consejos detallados para mejorar mi salud financiera, reducir gastos innecesarios y optimizar mi presupuesto.\n\n--- DATOS ---\n`;
            
            if (transactions.length > 0) {
                transactions.forEach(t => {
                    const type = t.amount > 0 ? "Ingreso" : "Gasto";
                    report += `${type}: ${t.description}, Importe: ${t.amount.toFixed(2)} €\n`;
                });
            } else {
                report += "No hay transacciones registradas para este periodo.";
            }

            exportDataTextarea.value = report;
        }

        function copyToClipboard() {
            exportDataTextarea.select();
            document.execCommand('copy');
            copyDataBtn.innerText = '¡Copiado!';
            setTimeout(() => {
                copyDataBtn.innerText = 'Copiar al Portapapeles';
            }, 2000);
        }

        function openAnalysisModal() {
            const selectedMonthName = monthSelect.options[monthSelect.selectedIndex].text;
            analysisMonthYearEl.textContent = `${selectedMonthName} de ${yearInput.value}`;
            generateFeedback();
            generateExportText();
            analysisModal.classList.remove('modal-hidden');
        }

        function closeAnalysisModal() {
            analysisModal.classList.add('modal-hidden');
        }

        // --- EVENT LISTENERS ---
        form.addEventListener('submit', handleAddTransaction);
        monthSelect.addEventListener('change', refreshView);
        yearInput.addEventListener('change', refreshView);
        
        showAnalysisBtn.addEventListener('click', openAnalysisModal);
        closeAnalysisBtn.addEventListener('click', closeAnalysisModal);
        copyDataBtn.addEventListener('click', copyToClipboard);
        analysisModal.addEventListener('click', (e) => {
            if (e.target === analysisModal) closeAnalysisModal();
        });

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js').then(registration => {
              console.log('ServiceWorker registrado con éxito: ', registration.scope);
            }, err => {
              console.log('El registro del ServiceWorker ha fallado: ', err);
            });
          });
        }

        // --- INITIALIZATION ---
        setupDateSelectors();
        refreshView();
    </script>
</body>
</html>
